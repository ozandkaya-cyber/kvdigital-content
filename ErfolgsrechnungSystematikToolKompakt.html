<!doctype html>
<html lang="de-CH">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Systematik der Erfolgsrechnung - Interaktives Tool (Kompakt)</title>
  <style>
    :root {
      --paper: #fffdf8;
      --ink: #1f2937;
      --muted: #5b6470;
      --line: #e7ddd0;
      --brand: #0d6447;
      --brand-soft: #e8f7ef;
      --panel: #ffffff;
      --shadow: 0 14px 34px rgba(31, 41, 55, 0.08);
      --blue: #1d4ed8;
      --blue-dark: #0f4ba8;
      --green: #16a34a;
      --red: #d63f45;
      --gray: #9ca3af;
      --amber: #b45309;
      --marker: rgba(250, 204, 21, 0.35);
      --marker-strong: rgba(245, 158, 11, 0.5);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Avenir Next", "Segoe UI", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 12% 8%, #dcefe0 0%, transparent 30%),
        radial-gradient(circle at 90% 16%, #dfeaff 0%, transparent 28%),
        linear-gradient(180deg, #f8f4ed, #f1e9dd);
      padding: 12px;
    }

    .app {
      max-width: 1000px;
      margin: 0 auto;
      background: var(--paper);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #b9dbc7;
      background: var(--brand-soft);
      color: var(--brand);
      font-size: 0.8rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.2rem, 2.6vw, 1.82rem);
      color: #143528;
    }

    .lead {
      margin: 6px 0 10px;
      color: var(--muted);
      line-height: 1.35;
      font-size: 0.9rem;
      max-width: 100ch;
    }

    .panel {
      border: 1px solid var(--line);
      border-radius: 13px;
      background: var(--panel);
      padding: 10px;
      margin-bottom: 9px;
    }

    .panel.compact {
      padding: 8px 9px;
      margin-bottom: 8px;
    }

    .panel h2 {
      margin: 0 0 8px;
      font-size: 0.98rem;
      color: #1b3553;
    }

    .param-details summary {
      list-style: none;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #d8e3f2;
      border-radius: 10px;
      background: #f6f9ff;
      padding: 7px 9px;
      font-size: 0.86rem;
      font-weight: 700;
      color: #1f3451;
      margin-bottom: 6px;
      user-select: none;
    }

    .param-details summary::-webkit-details-marker { display: none; }

    .param-hint {
      font-size: 0.75rem;
      color: #4f5f79;
      font-weight: 600;
    }

    .param-content {
      display: grid;
      gap: 6px;
    }

    .preset-row {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 4px;
    }

    .preset-btn {
      border: 1px solid #d7e2f1;
      background: #f6f9ff;
      color: #1f3451;
      border-radius: 10px;
      padding: 5px 8px;
      font: inherit;
      font-weight: 700;
      font-size: 0.79rem;
      cursor: pointer;
      transition: transform 0.12s ease, filter 0.12s ease;
    }

    .preset-btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
    }

    .preset-btn.active {
      border-color: #1d4ed8;
      box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.12);
      background: #eef4ff;
    }

    .control-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 5px 8px;
    }

    .control-row {
      display: grid;
      grid-template-columns: minmax(120px, 1fr) minmax(130px, 1.7fr) 88px;
      gap: 5px;
      align-items: center;
      border: 1px solid #ebe1d3;
      border-radius: 9px;
      background: #fffdfa;
      padding: 5px 6px;
    }

    .control-row label {
      font-size: 0.76rem;
      color: #2a3343;
      font-weight: 700;
      line-height: 1.2;
    }

    input[type="range"] {
      width: 100%;
      accent-color: #0f6c4d;
    }

    input[type="number"] {
      width: 100%;
      border: 1px solid #d5ccc0;
      border-radius: 9px;
      padding: 5px 6px;
      text-align: right;
      font: inherit;
      background: #fff;
      font-size: 0.79rem;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: #2b7a5b;
      box-shadow: 0 0 0 3px rgba(43, 122, 91, 0.14);
    }

    .actions {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
    }

    button.action {
      border: 0;
      border-radius: 10px;
      padding: 6px 8px;
      font: inherit;
      font-weight: 700;
      font-size: 0.79rem;
      cursor: pointer;
      transition: transform 0.12s ease, filter 0.12s ease;
    }

    button.action:hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
    }

    .btn-main {
      background: #154a87;
      color: #fff;
    }

    .btn-soft {
      background: #f0e9de;
      border: 1px solid #e0d4c4;
      color: #2a313b;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 0.85fr);
      gap: 8px;
    }

    .panel-head {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }

    .tag {
      border: 1px solid #d8e3f2;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.78rem;
      background: #f4f8ff;
      color: #22344f;
      font-weight: 700;
    }

    .profile-note {
      margin: 0 0 4px;
      color: #5b6470;
      font-size: 0.75rem;
    }

    .chart-wrap {
      border: 1px solid #ded6ca;
      border-radius: 11px;
      background: #fff;
      padding: 8px;
      max-width: 1120px;
      margin: 0 auto;
    }

    .chart-wrap.playing {
      border-color: #f59e0b;
      box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.16);
    }

    svg {
      display: block;
      width: 100%;
      height: auto;
    }

    .step-group rect.bar {
      cursor: pointer;
      transition: opacity 0.12s ease, transform 0.12s ease;
    }

    .step-group rect.marker {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.16s ease;
    }

    .step-group:hover rect.bar {
      opacity: 0.92;
    }

    .step-group.active rect.marker {
      opacity: 1;
    }

    .step-group.active rect.bar {
      stroke: #d97706;
      stroke-width: 4;
    }

    .step-group.active.autoplay rect.marker {
      fill: var(--marker-strong);
      animation: markerPulse 1.05s ease-in-out infinite;
    }

    .step-nav {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 5px;
      margin-top: 6px;
    }

    .step-chip {
      border: 1px solid #d8e3f2;
      border-radius: 10px;
      background: #f8fbff;
      color: #22344f;
      font: inherit;
      padding: 6px 7px;
      text-align: center;
      cursor: pointer;
      font-size: 0.74rem;
      line-height: 1.18;
    }

    .step-chip.active {
      border-color: #1d4ed8;
      box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.12);
      background: #eef4ff;
    }

    .step-chip.active.autoplay {
      border-color: #d97706;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
      background: rgba(250, 204, 21, 0.25);
    }

    .step-chip strong {
      display: block;
      margin-bottom: 0;
      font-size: 0.75rem;
    }

    .info-title {
      margin: 0 0 6px;
      color: #14345a;
      font-size: 0.96rem;
    }

    .info-lead {
      margin: 0 0 7px;
      color: #4b5563;
      font-size: 0.82rem;
      line-height: 1.32;
    }

    .stat-list {
      display: grid;
      gap: 5px;
      margin-bottom: 7px;
    }

    .stat-item {
      border: 1px solid #e6ddcf;
      border-radius: 10px;
      background: #fffdf8;
      padding: 7px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
    }

    .stat-item span { color: #5b6470; }
    .stat-item strong { color: #0f172a; }

    .formula,
    .accounts,
    .note {
      border: 1px solid #e6ddcf;
      border-radius: 10px;
      background: #fffdf8;
      padding: 7px 8px;
      margin-bottom: 6px;
      font-size: 0.8rem;
      line-height: 1.3;
    }

    .formula {
      background: #f7fbff;
      border-color: #d6e4f5;
      color: #1f3d5e;
      font-weight: 700;
    }

    .accounts {
      background: #f5fbf7;
      border-color: #cbe6d4;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
    }

    .kpi {
      border: 1px solid #dfe7f3;
      border-radius: 11px;
      background: #f8fbff;
      padding: 7px 8px;
    }

    .kpi .label {
      font-size: 0.76rem;
      color: #536178;
      margin-bottom: 3px;
    }

    .kpi .value {
      font-size: 0.98rem;
      font-weight: 800;
    }

    .kpi.pos .value { color: #166534; }
    .kpi.neg .value { color: #b91c1c; }

    .foot {
      margin-top: 6px;
      color: #5f6775;
      font-size: 0.74rem;
    }

    @keyframes markerPulse {
      0% { opacity: 0.45; }
      50% { opacity: 0.95; }
      100% { opacity: 0.45; }
    }

    @media (max-width: 1080px) {
      .grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 980px) {
      .step-nav { grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .control-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 760px) {
      .control-row {
        grid-template-columns: 1fr;
      }

      .step-nav {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .kpi-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <span class="badge">INTERAKTIVES TOOL: Systematik der Erfolgsrechnung</span>
    <h1>Erfolgsrechnung als klickbares Stufenmodell (Kompakt)</h1>
    <p class="lead">
      Dieses Tool ist kein Test, sondern ein Explorationsraum: Klicken Sie auf eine Stufe im Chart,
      verändern Sie die Werte und beobachten Sie, wie sich Bruttoergebnis, EBIT und Jahresüberschuss verändern.
    </p>

    <details class="panel compact param-details">
      <summary>
        <span>Parameter ein-/ausblenden</span>
        <span class="param-hint">Kompaktansicht</span>
      </summary>
      <div class="param-content">
        <div class="preset-row" id="presetRow"></div>
        <p class="profile-note" id="profileNote"></p>
        <div class="control-grid" id="controlGrid"></div>
        <div class="actions">
          <button type="button" class="action btn-soft" id="randomizeBtn">Werte variieren</button>
          <button type="button" class="action btn-main" id="playBtn">Ablauf abspielen</button>
          <button type="button" class="action btn-soft" id="resetBtn">Auf Standard zurücksetzen</button>
        </div>
      </div>
    </details>

    <section class="grid">
      <article class="panel">
        <div class="panel-head">
          <h2>Stufen-Chart</h2>
          <span class="tag" id="profileTag">Profil: -</span>
        </div>
        <div class="chart-wrap" id="chartWrap">
          <svg id="waterfallSvg" viewBox="0 0 1160 620" aria-label="Interaktives Stufenmodell der Erfolgsrechnung"></svg>
        </div>
        <div class="step-nav" id="stepNav"></div>
        <p class="foot">
          Leselogik: Grün startet bei den Umsätzen, rote Stufen ziehen Aufwand ab, graue/blaue Stufen zeigen Zwischenergebnisse.
        </p>
      </article>

      <article class="panel">
        <h2 class="info-title" id="infoTitle">1. Umsatzerlöse</h2>
        <p class="info-lead" id="infoLead"></p>
        <div class="stat-list">
          <div class="stat-item"><span>Aktueller Wert</span><strong id="infoValue">-</strong></div>
          <div class="stat-item"><span>Bezug zum Umsatz</span><strong id="infoRatio">-</strong></div>
        </div>
        <div class="formula" id="infoFormula"></div>
        <div class="accounts" id="infoAccounts"></div>
        <div class="note" id="infoNote"></div>
      </article>
    </section>

    <section class="panel">
      <h2>Margenüberblick</h2>
      <div class="kpi-grid">
        <div class="kpi" id="grossKpi">
          <div class="label">Bruttomarge</div>
          <div class="value" id="grossMarginValue">-</div>
        </div>
        <div class="kpi" id="ebitKpi">
          <div class="label">EBIT-Marge</div>
          <div class="value" id="ebitMarginValue">-</div>
        </div>
        <div class="kpi" id="netKpi">
          <div class="label">Nettomarge</div>
          <div class="value" id="netMarginValue">-</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const profiles = [
      {
        id: "handel",
        label: "Handel",
        note: "Typisch: hoher Materialaufwand, Bruttomarge als zentrale Stellgrösse.",
        values: { revenue: 4200, material: 2700, overhead: 760, depr: 180, finTax: 140 }
      },
      {
        id: "produktion",
        label: "Produktion",
        note: "Typisch: höhere Fixkosten und Abschreibungen durch Maschinenpark.",
        values: { revenue: 5200, material: 2950, overhead: 980, depr: 420, finTax: 230 }
      },
      {
        id: "dienstleistung",
        label: "Dienstleistung",
        note: "Typisch: tiefer Materialaufwand, dafür hohe Personal- und Strukturkosten.",
        values: { revenue: 3600, material: 500, overhead: 2200, depr: 110, finTax: 160 }
      },
      {
        id: "gastronomie",
        label: "Gastronomie",
        note: "Typisch: Material und Personal wirken gleichzeitig stark auf das Ergebnis.",
        values: { revenue: 3100, material: 1150, overhead: 1420, depr: 150, finTax: 120 }
      }
    ];

    const controls = [
      { key: "revenue", label: "Umsatzerlöse", min: 1000, max: 12000, step: 50 },
      { key: "material", label: "Herstellkosten / Materialaufwand", min: 0, max: 10000, step: 50 },
      { key: "overhead", label: "Personal-, Verwaltungs- und Vertriebskosten", min: 0, max: 9000, step: 50 },
      { key: "depr", label: "Abschreibungen", min: 0, max: 4000, step: 10 },
      { key: "finTax", label: "Zinsen & Steuern", min: 0, max: 3000, step: 10 }
    ];

    const stepInfo = {
      1: {
        title: "1. Umsatzerlöse",
        lead: "Die Umsatzstufe ist der Startpunkt der Erfolgsrechnung. Von hier aus werden nacheinander Aufwandblöcke abgezogen.",
        formula: "Ausgangspunkt: Umsatzerlöse (Nettoerlös)",
        accounts: "KMU-Kontenplan: Kontenklasse 3 (Betrieblicher Ertrag, z. B. Warenertrag oder Dienstleistungsertrag).",
        note: "Didaktik: Wer diese Stufe versteht, erkennt, dass alle Margen letztlich vom Umsatz getragen werden."
      },
      2: {
        title: "2. Herstellkosten / Materialaufwand",
        lead: "Diese Stufe reduziert den Umsatz direkt. Je höher dieser Block, desto kleiner wird das Bruttoergebnis.",
        formula: "Bruttoergebnis = Umsatzerlöse - Herstellkosten / Materialaufwand",
        accounts: "KMU-Kontenplan: Kontenklasse 4 (Material-, Waren- und Fremdleistungsaufwand).",
        note: "Didaktik: Diese Stufe trennt unmittelbar produktbezogene Kosten von den übrigen Betriebsaufwänden."
      },
      3: {
        title: "3. Bruttoergebnis",
        lead: "Das Bruttoergebnis zeigt, was nach den direkten Leistungskosten zur Deckung der Betriebsstruktur übrig bleibt.",
        formula: "Bruttoergebnis = Stufe 1 - Stufe 2",
        accounts: "Zwischenergebnis aus Klasse 3 und 4; keine eigene Kontenklasse, aber zentrale Führungsgrösse.",
        note: "Didaktik: Bruttomarge ist eine Kernkennzahl für Preisgestaltung und Einkaufspolitik."
      },
      4: {
        title: "4. Personal-, Verwaltungs- und Vertriebskosten",
        lead: "Hier wirken die operativen Strukturkosten. Dieser Block entscheidet stark über die operative Effizienz.",
        formula: "Zwischenstufe = Bruttoergebnis - Personal-, Verwaltungs- und Vertriebskosten",
        accounts: "KMU-Kontenplan: vor allem Kontenklasse 5 (Personalaufwand) und Teile der Kontenklasse 6 (Betriebsaufwand).",
        note: "Didaktik: Diese Stufe verbindet Organisation, Prozesse und Produktivität mit dem finanziellen Ergebnis."
      },
      5: {
        title: "5. Abschreibungen",
        lead: "Abschreibungen bilden den Wertverzehr der Anlagen ab und reduzieren das Betriebsergebnis ohne direkten Geldabfluss.",
        formula: "EBIT-Vorstufe = Zwischenstufe - Abschreibungen",
        accounts: "KMU-Kontenplan: Kontenklasse 6 (Abschreibungen und Wertberichtigungen auf Anlagevermögen).",
        note: "Didaktik: Diese Stufe zeigt den Unterschied zwischen Erfolg und Liquidität."
      },
      6: {
        title: "6. EBIT (Betriebsergebnis)",
        lead: "Das EBIT zeigt die Ertragskraft aus dem Kerngeschäft vor Finanzierungs- und Steuerwirkung.",
        formula: "EBIT = Bruttoergebnis - Personal/Verwaltung/Vertrieb - Abschreibungen",
        accounts: "Zwischenergebnis der betrieblichen Konten (v. a. Klassen 3 bis 6).",
        note: "Didaktik: EBIT macht betriebliche Leistung zwischen Unternehmen besser vergleichbar."
      },
      7: {
        title: "7. Zinsen & Steuern",
        lead: "Diese Stufe zeigt, wie Finanzierung und steuerliche Belastung den operativen Erfolg weiter verändern.",
        formula: "Jahresüberschuss = EBIT - Zinsen & Steuern",
        accounts: "KMU-Kontenplan: Finanzaufwand (i. d. R. Klasse 6) und Steueraufwand (je nach Abschlussgliederung, oft Klasse 8/9).",
        note: "Didaktik: Gute EBIT-Werte können durch Finanzierung oder Steuern deutlich reduziert werden."
      },
      8: {
        title: "8. Jahresüberschuss",
        lead: "Der Jahresüberschuss ist die finale Erfolgsgrösse der Periode und wirkt auf das Eigenkapital.",
        formula: "Jahresüberschuss = Stufe 6 - Stufe 7",
        accounts: "Abschlussgrösse: Ergebnisrechnung mit Übertrag in Eigenkapital/Ergebnisverwendung.",
        note: "Didaktik: Diese Stufe macht sichtbar, ob das Geschäftsmodell insgesamt nachhaltig Gewinn erwirtschaftet."
      }
    };

    const stepLabels = [
      { id: 1, short: "Umsatz" },
      { id: 2, short: "Material" },
      { id: 3, short: "Brutto" },
      { id: 4, short: "PVV" },
      { id: 5, short: "Abschr." },
      { id: 6, short: "EBIT" },
      { id: 7, short: "Zins+St." },
      { id: 8, short: "Jahresü." }
    ];

    const state = {
      activeProfile: profiles[0].id,
      values: { ...profiles[0].values },
      selectedStep: 1,
      playTimer: null
    };

    const el = {
      presetRow: document.getElementById("presetRow"),
      profileNote: document.getElementById("profileNote"),
      profileTag: document.getElementById("profileTag"),
      controlGrid: document.getElementById("controlGrid"),
      randomizeBtn: document.getElementById("randomizeBtn"),
      playBtn: document.getElementById("playBtn"),
      resetBtn: document.getElementById("resetBtn"),
      chartWrap: document.getElementById("chartWrap"),
      svg: document.getElementById("waterfallSvg"),
      stepNav: document.getElementById("stepNav"),
      infoTitle: document.getElementById("infoTitle"),
      infoLead: document.getElementById("infoLead"),
      infoValue: document.getElementById("infoValue"),
      infoRatio: document.getElementById("infoRatio"),
      infoFormula: document.getElementById("infoFormula"),
      infoAccounts: document.getElementById("infoAccounts"),
      infoNote: document.getElementById("infoNote"),
      grossKpi: document.getElementById("grossKpi"),
      ebitKpi: document.getElementById("ebitKpi"),
      netKpi: document.getElementById("netKpi"),
      grossMarginValue: document.getElementById("grossMarginValue"),
      ebitMarginValue: document.getElementById("ebitMarginValue"),
      netMarginValue: document.getElementById("netMarginValue")
    };

    function fmt(value) {
      return new Intl.NumberFormat("de-CH").format(Math.round(value));
    }

    function fmtCHF(value) {
      const sign = value < 0 ? "-" : "";
      return `${sign}CHF ${fmt(Math.abs(value))}`;
    }

    function fmtPct(value) {
      return `${value.toFixed(1).replace(".", ",")} %`;
    }

    function clamp(value, min, max) {
      return Math.min(max, Math.max(min, value));
    }

    function snap(value, step) {
      return Math.round(value / step) * step;
    }

    function randomBetween(min, max, step) {
      const count = Math.floor((max - min) / step);
      return min + Math.floor(Math.random() * (count + 1)) * step;
    }

    function profileById(id) {
      return profiles.find((p) => p.id === id) || null;
    }

    function computeModel(values) {
      const revenue = values.revenue;
      const material = values.material;
      const overhead = values.overhead;
      const depr = values.depr;
      const finTax = values.finTax;

      const gross = revenue - material;
      const opBeforeDepr = gross - overhead;
      const ebit = opBeforeDepr - depr;
      const net = ebit - finTax;

      return {
        revenue,
        material,
        overhead,
        depr,
        finTax,
        gross,
        opBeforeDepr,
        ebit,
        net
      };
    }

    function buildSeries(model) {
      return [
        { id: 1, kind: "delta", short: "Umsatz", label: "Umsatzerlöse", start: 0, end: model.revenue, value: model.revenue },
        { id: 2, kind: "delta", short: "Material", label: "Herstellkosten / Materialaufwand", start: model.revenue, end: model.gross, value: -model.material },
        { id: 3, kind: "subtotal", short: "Brutto", label: "Bruttoergebnis", start: 0, end: model.gross, value: model.gross },
        { id: 4, kind: "delta", short: "PVV", label: "Personal-, Verwaltungs- und Vertriebskosten", start: model.gross, end: model.opBeforeDepr, value: -model.overhead },
        { id: 5, kind: "delta", short: "Abschr.", label: "Abschreibungen", start: model.opBeforeDepr, end: model.ebit, value: -model.depr },
        { id: 6, kind: "subtotal", short: "EBIT", label: "EBIT (Betriebsergebnis)", start: 0, end: model.ebit, value: model.ebit },
        { id: 7, kind: "delta", short: "Zins+St.", label: "Zinsen & Steuern", start: model.ebit, end: model.net, value: -model.finTax },
        { id: 8, kind: "subtotal", short: "Jahresü.", label: "Jahresüberschuss", start: 0, end: model.net, value: model.net }
      ];
    }

    function stageColor(stage) {
      if (stage.kind === "delta") {
        return stage.value >= 0 ? "var(--green)" : "var(--red)";
      }

      if (stage.id === 3) {
        return stage.end >= 0 ? "var(--gray)" : "var(--amber)";
      }

      if (stage.id === 6 || stage.id === 8) {
        return stage.end >= 0 ? "var(--blue-dark)" : "#b91c1c";
      }

      return "var(--gray)";
    }

    function marginRatio(value, revenue) {
      if (revenue === 0) return 0;
      return (value / revenue) * 100;
    }

    function createSvgElement(tag, attrs = {}) {
      const node = document.createElementNS("http://www.w3.org/2000/svg", tag);
      Object.entries(attrs).forEach(([k, v]) => node.setAttribute(k, String(v)));
      return node;
    }

    function renderChart(series) {
      const svg = el.svg;
      svg.innerHTML = "";

      const width = 1160;
      const height = 620;
      const margin = { top: 24, right: 18, bottom: 98, left: 68 };
      const plotWidth = width - margin.left - margin.right;
      const plotHeight = height - margin.top - margin.bottom;
      const barWidth = 98;
      const gap = (plotWidth - barWidth * series.length) / (series.length - 1);

      const allValues = [0];
      series.forEach((s) => {
        allValues.push(s.start, s.end);
      });

      let minVal = Math.min(...allValues);
      let maxVal = Math.max(...allValues);
      const span = Math.max(300, maxVal - minVal);
      const pad = Math.max(140, span * 0.15);
      minVal -= pad;
      maxVal += pad;

      const y = (v) => margin.top + ((maxVal - v) / (maxVal - minVal)) * plotHeight;
      const zeroY = y(0);

      const gridCount = 6;
      for (let i = 0; i <= gridCount; i += 1) {
        const ratio = i / gridCount;
        const value = minVal + (maxVal - minVal) * (1 - ratio);
        const lineY = margin.top + plotHeight * ratio;
        const isZero = Math.abs(value) < (maxVal - minVal) / 200;

        const line = createSvgElement("line", {
          x1: margin.left,
          y1: lineY,
          x2: width - margin.right,
          y2: lineY,
          stroke: isZero ? "#6b7280" : "#e5e7eb",
          "stroke-width": isZero ? 1.6 : 1
        });
        svg.appendChild(line);

        const label = createSvgElement("text", {
          x: margin.left - 8,
          y: lineY + 4,
          "text-anchor": "end",
          "font-size": 13,
          fill: "#6b7280"
        });
        label.textContent = fmt(value);
        svg.appendChild(label);
      }

      const positions = series.map((s, index) => ({
        ...s,
        x: margin.left + index * (barWidth + gap)
      }));

      for (let i = 0; i < positions.length - 1; i += 1) {
        const current = positions[i];
        const next = positions[i + 1];
        const connector = createSvgElement("line", {
          x1: current.x + barWidth,
          y1: y(current.end),
          x2: next.x,
          y2: y(current.end),
          stroke: "#aeb6c1",
          "stroke-width": 1.8
        });
        svg.appendChild(connector);
      }

      positions.forEach((stage) => {
        const yStart = y(stage.start);
        const yEnd = y(stage.end);
        const top = Math.min(yStart, yEnd);
        const heightPx = Math.max(2, Math.abs(yStart - yEnd));

        const group = createSvgElement("g", {
          class: `step-group${state.selectedStep === stage.id ? " active" : ""}${state.playTimer && state.selectedStep === stage.id ? " autoplay" : ""}`,
          "data-step": stage.id,
          tabindex: 0,
          role: "button",
          "aria-label": `${stage.id}. ${stage.label}`
        });

        const marker = createSvgElement("rect", {
          class: "marker",
          x: stage.x - 8,
          y: top - 8,
          width: barWidth + 16,
          height: heightPx + 16,
          rx: 7,
          fill: "var(--marker)"
        });
        group.appendChild(marker);

        const rect = createSvgElement("rect", {
          class: "bar",
          x: stage.x,
          y: top,
          width: barWidth,
          height: heightPx,
          rx: 4,
          fill: stageColor(stage)
        });
        group.appendChild(rect);

        const idText = createSvgElement("text", {
          x: stage.x + barWidth / 2,
          y: height - margin.bottom + 24,
          "text-anchor": "middle",
          "font-size": 14,
          fill: "#374151",
          "font-weight": "700"
        });
        idText.textContent = `${stage.id}.`;
        group.appendChild(idText);

        const labelText = createSvgElement("text", {
          x: stage.x + barWidth / 2,
          y: height - margin.bottom + 43,
          "text-anchor": "middle",
          "font-size": 14,
          fill: "#374151"
        });
        labelText.textContent = stepLabels.find((s) => s.id === stage.id).short;
        group.appendChild(labelText);

        const amount = stage.kind === "delta" ? stage.value : stage.end;
        const amountText = createSvgElement("text", {
          x: stage.x + barWidth / 2,
          y: top - 7,
          "text-anchor": "middle",
          "font-size": 15,
          fill: "#111827",
          "font-weight": "700"
        });
        amountText.textContent = fmtCHF(amount);

        if (top < margin.top + 12) {
          amountText.setAttribute("y", String(top + heightPx + 16));
        }

        group.appendChild(amountText);

        group.addEventListener("click", () => {
          selectStep(stage.id, true);
        });

        group.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            selectStep(stage.id, true);
          }
        });

        svg.appendChild(group);
      });

      const zeroLine = createSvgElement("line", {
        x1: margin.left,
        y1: zeroY,
        x2: width - margin.right,
        y2: zeroY,
        stroke: "#6b7280",
        "stroke-width": 1.8
      });
      svg.appendChild(zeroLine);
    }

    function renderStepNav() {
      el.stepNav.innerHTML = stepLabels.map((step) => {
        const active = step.id === state.selectedStep ? "active" : "";
        const autoplay = state.playTimer && step.id === state.selectedStep ? "autoplay" : "";
        return `<button type="button" class="step-chip ${active} ${autoplay}" data-step="${step.id}"><strong>${step.id}. ${step.short}</strong></button>`;
      }).join("");

      el.stepNav.querySelectorAll("button").forEach((btn) => {
        btn.addEventListener("click", () => {
          selectStep(Number(btn.dataset.step), true);
        });
      });
    }

    function updateProfileTag() {
      if (state.activeProfile === "custom") {
        el.profileTag.textContent = "Profil: Individuell";
        el.profileNote.textContent = "Individuelle Werte: Sie steuern die Kostenblöcke direkt über die Regler.";
        return;
      }

      const profile = profileById(state.activeProfile);
      el.profileTag.textContent = `Profil: ${profile.label}`;
      el.profileNote.textContent = profile.note;
    }

    function ratioText(stepId, model) {
      if (model.revenue === 0) return "-";

      switch (stepId) {
        case 1:
          return "100,0 % vom Umsatz";
        case 2:
          return `${fmtPct((model.material / model.revenue) * 100)} vom Umsatz`;
        case 3:
          return `${fmtPct((model.gross / model.revenue) * 100)} Bruttomarge`;
        case 4:
          return `${fmtPct((model.overhead / model.revenue) * 100)} vom Umsatz`;
        case 5:
          return `${fmtPct((model.depr / model.revenue) * 100)} vom Umsatz`;
        case 6:
          return `${fmtPct((model.ebit / model.revenue) * 100)} EBIT-Marge`;
        case 7:
          return `${fmtPct((model.finTax / model.revenue) * 100)} vom Umsatz`;
        case 8:
          return `${fmtPct((model.net / model.revenue) * 100)} Nettomarge`;
        default:
          return "-";
      }
    }

    function stepValue(stepId, model) {
      switch (stepId) {
        case 1: return model.revenue;
        case 2: return -model.material;
        case 3: return model.gross;
        case 4: return -model.overhead;
        case 5: return -model.depr;
        case 6: return model.ebit;
        case 7: return -model.finTax;
        case 8: return model.net;
        default: return 0;
      }
    }

    function renderInfo(model) {
      const info = stepInfo[state.selectedStep];
      el.infoTitle.textContent = info.title;
      el.infoLead.textContent = info.lead;
      el.infoFormula.textContent = info.formula;
      el.infoAccounts.textContent = info.accounts;
      el.infoNote.textContent = info.note;
      el.infoValue.textContent = fmtCHF(stepValue(state.selectedStep, model));
      el.infoRatio.textContent = ratioText(state.selectedStep, model);
    }

    function setKpiState(card, valueEl, marginValue) {
      card.classList.remove("pos", "neg");
      card.classList.add(marginValue >= 0 ? "pos" : "neg");
      valueEl.textContent = fmtPct(marginValue);
    }

    function renderKpis(model) {
      const grossMargin = marginRatio(model.gross, model.revenue);
      const ebitMargin = marginRatio(model.ebit, model.revenue);
      const netMargin = marginRatio(model.net, model.revenue);

      setKpiState(el.grossKpi, el.grossMarginValue, grossMargin);
      setKpiState(el.ebitKpi, el.ebitMarginValue, ebitMargin);
      setKpiState(el.netKpi, el.netMarginValue, netMargin);
    }

    function syncControlUi() {
      controls.forEach((control) => {
        const r = document.getElementById(`r-${control.key}`);
        const n = document.getElementById(`n-${control.key}`);
        if (!r || !n) return;
        r.value = state.values[control.key];
        n.value = state.values[control.key];
      });
    }

    function updatePresetButtons() {
      el.presetRow.querySelectorAll("button").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.profile === state.activeProfile);
      });
    }

    function applyControlValue(key, raw) {
      const meta = controls.find((c) => c.key === key);
      if (!meta) return;
      const prepared = clamp(snap(Number(raw) || 0, meta.step), meta.min, meta.max);
      state.values[key] = prepared;
      document.getElementById(`r-${key}`).value = prepared;
      document.getElementById(`n-${key}`).value = prepared;

      if (state.activeProfile !== "custom") {
        state.activeProfile = "custom";
      }
      update();
    }

    function selectProfile(profileId) {
      const profile = profileById(profileId);
      if (!profile) return;
      state.activeProfile = profile.id;
      state.values = { ...profile.values };
      syncControlUi();
      update();
    }

    function resetToDefault() {
      stopPlayback();
      selectProfile(profiles[0].id);
      selectStep(1, false);
    }

    function randomizeValues() {
      const base = state.activeProfile === "custom"
        ? { ...state.values }
        : { ...profileById(state.activeProfile).values };

      state.values = {
        revenue: randomBetween(Math.round(base.revenue * 0.8), Math.round(base.revenue * 1.2), 50),
        material: randomBetween(Math.round(base.material * 0.75), Math.round(base.material * 1.25), 50),
        overhead: randomBetween(Math.round(base.overhead * 0.75), Math.round(base.overhead * 1.25), 50),
        depr: randomBetween(Math.round(base.depr * 0.7), Math.round(base.depr * 1.35), 10),
        finTax: randomBetween(Math.round(base.finTax * 0.65), Math.round(base.finTax * 1.4), 10)
      };
      state.activeProfile = "custom";
      syncControlUi();
      update();
    }

    function selectStep(stepId, stopAutoPlay) {
      state.selectedStep = stepId;
      if (stopAutoPlay) stopPlayback();
      update();
    }

    function togglePlayback() {
      if (state.playTimer) {
        stopPlayback();
        return;
      }

      let current = state.selectedStep;
      el.playBtn.textContent = "Stopp (Tour läuft)";
      el.chartWrap.classList.add("playing");
      state.playTimer = window.setInterval(() => {
        current = (current % 8) + 1;
        state.selectedStep = current;
        update();
      }, 1250);
    }

    function stopPlayback() {
      if (state.playTimer) {
        window.clearInterval(state.playTimer);
        state.playTimer = null;
      }
      el.chartWrap.classList.remove("playing");
      el.playBtn.textContent = "Ablauf abspielen";
    }

    function update() {
      const model = computeModel(state.values);
      const series = buildSeries(model);
      renderChart(series);
      renderStepNav();
      renderInfo(model);
      renderKpis(model);
      updateProfileTag();
      updatePresetButtons();
    }

    function renderPresets() {
      el.presetRow.innerHTML = profiles
        .map((profile) => `<button type="button" class="preset-btn" data-profile="${profile.id}">${profile.label}</button>`)
        .join("");

      el.presetRow.querySelectorAll("button").forEach((btn) => {
        btn.addEventListener("click", () => {
          stopPlayback();
          selectProfile(btn.dataset.profile);
        });
      });
    }

    function renderControls() {
      el.controlGrid.innerHTML = controls.map((control) => {
        return `
          <div class="control-row">
            <label for="r-${control.key}">${control.label}</label>
            <input id="r-${control.key}" type="range" min="${control.min}" max="${control.max}" step="${control.step}" />
            <input id="n-${control.key}" type="number" min="${control.min}" max="${control.max}" step="${control.step}" />
          </div>
        `;
      }).join("");

      controls.forEach((control) => {
        const range = document.getElementById(`r-${control.key}`);
        const number = document.getElementById(`n-${control.key}`);

        range.addEventListener("input", () => {
          applyControlValue(control.key, range.value);
        });

        number.addEventListener("change", () => {
          applyControlValue(control.key, number.value);
        });
      });
    }

    function init() {
      renderPresets();
      renderControls();
      syncControlUi();

      el.randomizeBtn.addEventListener("click", () => {
        stopPlayback();
        randomizeValues();
      });

      el.playBtn.addEventListener("click", togglePlayback);
      el.resetBtn.addEventListener("click", resetToDefault);

      update();
    }

    init();
  </script>
</body>
</html>
