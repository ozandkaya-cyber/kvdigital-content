<!doctype html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interaktive BWL-Simulation (Embed): Nutzschwelle und Deckungsbeitrag</title>
  <style>
    :root {
      --hintergrund-oben: #dde8f4;
      --hintergrund-unten: #edf2f6;
      --rahmen: #d0d8e0;
      --karte: #f5f7f9;
      --karte-innen: #ffffff;
      --text: #303945;
      --text-gedimmt: #5f6c7a;
      --akzent: #0f7b59;
      --akzent-2: #ff6b1a;
      --akzent-3: #c83df2;
      --linie-umsatz: #c2410c;
      --linie-kosten: #334155;
      --linie-fix: #64748b;
      --gut: #1f8f58;
      --schlecht: #c43c3c;
      --schatten: 0 16px 38px rgba(41, 55, 73, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: inherit;
      color: var(--text);
      background: transparent;
      min-height: 0;
      padding: 0;
    }

    .modul {
      max-width: none;
      margin: 0;
      border: 0;
      border-radius: 0;
      background: transparent;
      box-shadow: none;
      padding: 0;
      display: grid;
      gap: 12px;
    }

    .kopf {
      border: 1px solid #d1d9e1;
      border-radius: 16px;
      background: linear-gradient(90deg, #e7edf5, #f2f5f8);
      padding: 14px 16px;
      display: grid;
      gap: 8px;
    }

    .titelzeile {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .badge {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 4px 10px;
      font-size: 0.8rem;
      font-weight: 700;
      color: #3b454f;
      background:
        linear-gradient(#f7f8fa, #f7f8fa) padding-box,
        linear-gradient(90deg, var(--akzent-2), var(--akzent-3)) border-box;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.6rem, 3.4vw, 2.35rem);
      line-height: 1.1;
      color: #2d3641;
    }

    .einleitung {
      margin: 0;
      color: var(--text-gedimmt);
      line-height: 1.42;
      max-width: 95ch;
      font-size: 0.98rem;
    }

    .arbeitsbereich {
      display: grid;
      grid-template-columns: minmax(290px, 340px) minmax(0, 1fr);
      gap: 12px;
      align-items: start;
    }

    .arbeitsbereich > .karte {
      position: sticky;
      top: 10px;
    }

    .karte {
      border: 1px solid #d3dbe3;
      border-radius: 16px;
      background: var(--karte);
      padding: 12px;
    }

    .karte h2 {
      margin: 0 0 7px;
      font-size: 1.06rem;
      color: #33404e;
    }

    .karte .untertitel {
      margin: 0;
      font-size: 0.9rem;
      line-height: 1.35;
      color: var(--text-gedimmt);
    }

    .eingabe-liste {
      margin-top: 10px;
      display: grid;
      gap: 8px;
    }

    .eingabe {
      border: 1px solid #dbe2e9;
      border-radius: 11px;
      background: var(--karte-innen);
      padding: 9px;
      display: grid;
      gap: 6px;
    }

    .eingabe label {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      font-size: 0.86rem;
      line-height: 1.2;
      font-weight: 700;
      color: #3d4857;
    }

    .eingabe label span {
      color: var(--akzent);
      font-weight: 800;
      white-space: nowrap;
    }

    .eingabe input[type="range"] {
      width: 100%;
      accent-color: #169067;
      cursor: pointer;
    }

    .hinweis {
      margin-top: 10px;
      border: 1px solid #d8e0e7;
      border-radius: 11px;
      background: #f8fafc;
      padding: 10px;
      font-size: 0.9rem;
      line-height: 1.35;
      color: #4b5767;
      min-height: 74px;
    }

    .inhalt {
      overflow-x: visible;
      padding-bottom: 2px;
    }

    .analyse-ebenen {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      grid-template-areas:
        "grafik grafik"
        "zahlen zahlen"
        "balken balken";
      gap: 12px;
      align-items: start;
    }

    .ebene {
      border: 1px solid #d3dbe3;
      border-radius: 16px;
      background: var(--karte);
      padding: 12px;
      display: grid;
      gap: 8px;
      align-content: start;
    }

    .ebene-kopf {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .ebene h2 {
      margin: 0;
      font-size: 1.06rem;
      color: #33404e;
    }

    .ebene-toggle {
      border: 1px solid #ccd6de;
      background: #ffffff;
      color: #455264;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.78rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }

    .ebene-toggle:hover {
      background: #f4f7fa;
    }

    .ebene-inhalt {
      display: grid;
      gap: 8px;
    }

    .ebene[data-collapsed="true"] {
      padding-bottom: 10px;
    }

    .ebene[data-collapsed="true"] .ebene-inhalt {
      display: none;
    }

    .ebene[data-ebene="grafik"] {
      grid-area: grafik;
    }

    .ebene[data-ebene="zahlen"] {
      grid-area: zahlen;
    }

    .ebene[data-ebene="balken"] {
      grid-area: balken;
    }

    .analyse-ebenen[data-zahlen="collapsed"][data-balken="open"] {
      grid-template-areas:
        "grafik grafik"
        "balken balken";
    }

    .analyse-ebenen[data-balken="collapsed"][data-zahlen="open"] {
      grid-template-areas:
        "grafik grafik"
        "zahlen zahlen";
    }

    .analyse-ebenen[data-grafik="collapsed"][data-zahlen="open"][data-balken="open"] {
      grid-template-areas:
        "zahlen zahlen"
        "balken balken";
    }

    .analyse-ebenen[data-grafik="collapsed"][data-zahlen="open"][data-balken="collapsed"] {
      grid-template-areas: "zahlen zahlen";
    }

    .analyse-ebenen[data-grafik="collapsed"][data-zahlen="collapsed"][data-balken="open"] {
      grid-template-areas: "balken balken";
    }

    .kennzahlen-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .kennzahl {
      border: 1px solid #dbe2e9;
      border-radius: 11px;
      background: var(--karte-innen);
      padding: 9px;
      min-height: 78px;
    }

    .kennzahl h3 {
      margin: 0 0 4px;
      font-size: 0.76rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #657386;
    }

    .kennzahl p {
      margin: 0;
      font-size: 1.1rem;
      line-height: 1.12;
      font-weight: 800;
      color: #2f3946;
    }

    .kennzahl .info {
      margin-top: 4px;
      font-size: 0.78rem;
      color: #667587;
      line-height: 1.25;
      font-weight: 600;
    }

    .gut {
      color: var(--gut) !important;
    }

    .schlecht {
      color: var(--schlecht) !important;
    }

    .diagramm {
      border: 1px solid #dbe2e9;
      border-radius: 12px;
      background: #fff;
      padding: 8px;
    }

    svg {
      width: 100%;
      height: auto;
      display: block;
    }

    .legende {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      color: #606f81;
      font-size: 0.84rem;
    }

    .legende i {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 5px;
      vertical-align: -1px;
    }

    @media (max-width: 780px) {
      .arbeitsbereich {
        grid-template-columns: 1fr;
      }

      .arbeitsbereich > .karte {
        position: static;
      }

      .analyse-ebenen {
        grid-template-columns: 1fr !important;
        grid-template-areas:
          "grafik"
          "zahlen"
          "balken" !important;
      }
    }

    @media (max-width: 640px) {
      body {
        padding: 0;
      }

      .modul {
        border-radius: 0;
        padding: 0;
      }

      h1 {
        font-size: 1.45rem;
      }
    }
  </style>
</head>
<body>
  <section class="modul" aria-label="Interaktive Simulation">
    <header class="kopf">
      <div class="titelzeile">
        <span class="badge">Interaktion</span>
        <h1>Nutzschwelle, Deckungsbeitrag und Marge</h1>
      </div>
      <p class="einleitung">
        Dieses Modul konzentriert sich ausschließlich auf Ursache und Wirkung. Verändere Preis, variable Kosten,
        Fixkosten und Absatz, um die Effekte auf Nutzschwelle, Selbstkosten, Ergebnis und Marge zu sehen.
      </p>
    </header>

    <div class="arbeitsbereich">
      <aside class="karte" aria-label="Eingaben">
        <h2>Eingaben</h2>
        <p class="untertitel">Steuergrößen für die Simulation.</p>

        <div class="eingabe-liste">
          <div class="eingabe">
            <label for="price">
              Verkaufspreis pro Stück
              <span id="priceValue"></span>
            </label>
            <input id="price" type="range" min="10" max="300" step="1" value="75" />
          </div>

          <div class="eingabe">
            <label for="variableCost">
              Variable Kosten pro Stück
              <span id="variableCostValue"></span>
            </label>
            <input id="variableCost" type="range" min="5" max="250" step="1" value="42" />
          </div>

          <div class="eingabe">
            <label for="fixedCost">
              Fixkosten pro Periode
              <span id="fixedCostValue"></span>
            </label>
            <input id="fixedCost" type="range" min="1000" max="120000" step="500" value="24000" />
          </div>

          <div class="eingabe">
            <label for="quantity">
              Geplanter Absatz
              <span id="quantityValue"></span>
            </label>
            <input id="quantity" type="range" min="0" max="6000" step="10" value="1300" />
          </div>
        </div>

        <div class="hinweis" id="scenarioHint"></div>
      </aside>

      <div class="inhalt">
        <div class="analyse-ebenen" id="analyseEbenen">
          <section class="ebene" data-ebene="zahlen" data-collapsed="false" aria-label="Kennzahlen">
            <div class="ebene-kopf">
              <h2>Zahlen</h2>
              <button class="ebene-toggle" type="button" data-target="zahlen" aria-expanded="true">Zuklappen</button>
            </div>
            <div class="ebene-inhalt">
              <div class="kennzahlen-grid">
                <article class="kennzahl">
                  <h3>Deckungsbeitrag pro Stück</h3>
                  <p id="kpiDbUnit"></p>
                  <div class="info" id="kpiDbQuote"></div>
                </article>

                <article class="kennzahl">
                  <h3>Selbstkosten pro Stück</h3>
                  <p id="kpiSelfCost"></p>
                  <div class="info">inkl. Fixkostenanteil</div>
                </article>

                <article class="kennzahl">
                  <h3>Marge am Absatz</h3>
                  <p id="kpiMargin"></p>
                  <div class="info" id="kpiProfit"></div>
                </article>

                <article class="kennzahl">
                  <h3>Nutzschwelle</h3>
                  <p id="kpiBreakEvenQty"></p>
                  <div class="info" id="kpiBreakEvenRev"></div>
                </article>

                <article class="kennzahl">
                  <h3>Umsatz</h3>
                  <p id="kpiRevenue"></p>
                  <div class="info">beim geplanten Absatz</div>
                </article>

                <article class="kennzahl">
                  <h3>Gesamtkosten</h3>
                  <p id="kpiTotalCost"></p>
                  <div class="info">variabel + fix</div>
                </article>
              </div>
            </div>
          </section>

          <section class="ebene" data-ebene="grafik" data-collapsed="false" aria-label="Break-even-Diagramm">
            <div class="ebene-kopf">
              <h2>Grafik</h2>
              <button class="ebene-toggle" type="button" data-target="grafik" aria-expanded="true">Zuklappen</button>
            </div>
            <div class="ebene-inhalt">
              <div class="diagramm">
                <svg id="breakEvenChart" viewBox="0 0 860 460" aria-label="Break-even-Diagramm"></svg>
              </div>
              <div class="legende">
                <span><i style="background: #c2410c"></i>Umsatzlinie</span>
                <span><i style="background: #334155"></i>Gesamtkostenlinie</span>
                <span><i style="background: #64748b"></i>Fixkosten</span>
                <span><i style="background: #0f766e"></i>Break-even</span>
              </div>
            </div>
          </section>

          <section class="ebene" data-ebene="balken" data-collapsed="false" aria-label="Wirkungsdiagramm">
            <div class="ebene-kopf">
              <h2>Balken</h2>
              <button class="ebene-toggle" type="button" data-target="balken" aria-expanded="true">Zuklappen</button>
            </div>
            <div class="ebene-inhalt">
              <div class="diagramm">
                <svg id="impactChart" viewBox="0 0 860 340" aria-label="Balkenvergleich"></svg>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </section>

  <script>
    const svgNS = "http://www.w3.org/2000/svg";

    const currency = new Intl.NumberFormat("de-CH", {
      style: "currency",
      currency: "CHF",
      maximumFractionDigits: 0,
    });

    const percent = new Intl.NumberFormat("de-DE", {
      style: "percent",
      minimumFractionDigits: 1,
      maximumFractionDigits: 1,
    });

    const integer = new Intl.NumberFormat("de-DE", {
      maximumFractionDigits: 0,
    });

    const controls = {
      price: document.getElementById("price"),
      variableCost: document.getElementById("variableCost"),
      fixedCost: document.getElementById("fixedCost"),
      quantity: document.getElementById("quantity"),
    };

    const outputs = {
      priceValue: document.getElementById("priceValue"),
      variableCostValue: document.getElementById("variableCostValue"),
      fixedCostValue: document.getElementById("fixedCostValue"),
      quantityValue: document.getElementById("quantityValue"),
      scenarioHint: document.getElementById("scenarioHint"),

      kpiDbUnit: document.getElementById("kpiDbUnit"),
      kpiDbQuote: document.getElementById("kpiDbQuote"),
      kpiSelfCost: document.getElementById("kpiSelfCost"),
      kpiMargin: document.getElementById("kpiMargin"),
      kpiProfit: document.getElementById("kpiProfit"),
      kpiBreakEvenQty: document.getElementById("kpiBreakEvenQty"),
      kpiBreakEvenRev: document.getElementById("kpiBreakEvenRev"),
      kpiRevenue: document.getElementById("kpiRevenue"),
      kpiTotalCost: document.getElementById("kpiTotalCost"),

      breakEvenChart: document.getElementById("breakEvenChart"),
      impactChart: document.getElementById("impactChart"),
    };

    const analyseLayout = {
      container: document.getElementById("analyseEbenen"),
      panels: {
        zahlen: document.querySelector('[data-ebene="zahlen"]'),
        grafik: document.querySelector('[data-ebene="grafik"]'),
        balken: document.querySelector('[data-ebene="balken"]'),
      },
      ids: ["grafik", "zahlen", "balken"],
    };

    const setAnalyseLayout = () => {
      analyseLayout.ids.forEach((id) => {
        const panel = analyseLayout.panels[id];
        const button = panel.querySelector(".ebene-toggle");
        const isCollapsed = panel.dataset.collapsed === "true";
        button.setAttribute("aria-expanded", String(!isCollapsed));
        button.textContent = isCollapsed ? "Aufklappen" : "Zuklappen";
        analyseLayout.container.dataset[id] = isCollapsed ? "collapsed" : "open";
      });
    };

    const toggleAnalyseEbene = (id) => {
      const panel = analyseLayout.panels[id];
      const offenePanels = analyseLayout.ids.filter((key) => analyseLayout.panels[key].dataset.collapsed !== "true");
      const willCollapse = panel.dataset.collapsed !== "true";

      if (willCollapse && offenePanels.length === 1) {
        return;
      }

      panel.dataset.collapsed = panel.dataset.collapsed === "true" ? "false" : "true";
      setAnalyseLayout();
    };

    const readInputs = () => ({
      price: Number(controls.price.value),
      variableCost: Number(controls.variableCost.value),
      fixedCost: Number(controls.fixedCost.value),
      quantity: Number(controls.quantity.value),
    });

    const calculateModel = ({ price, variableCost, fixedCost, quantity }) => {
      const dbUnit = price - variableCost;
      const revenue = price * quantity;
      const variableTotal = variableCost * quantity;
      const totalCost = fixedCost + variableTotal;
      const dbTotal = dbUnit * quantity;
      const profit = dbTotal - fixedCost;
      const margin = revenue > 0 ? profit / revenue : 0;
      const dbQuote = price > 0 ? dbUnit / price : 0;
      const selfCostPerUnit = quantity > 0 ? totalCost / quantity : 0;
      const breakEvenQty = dbUnit > 0 ? fixedCost / dbUnit : Infinity;
      const breakEvenRevenue = Number.isFinite(breakEvenQty) ? breakEvenQty * price : Infinity;

      return {
        price,
        variableCost,
        fixedCost,
        quantity,
        dbUnit,
        revenue,
        variableTotal,
        totalCost,
        dbTotal,
        profit,
        margin,
        dbQuote,
        selfCostPerUnit,
        breakEvenQty,
        breakEvenRevenue,
      };
    };

    const scenarioText = (m) => {
      if (m.dbUnit <= 0) {
        return "Der Deckungsbeitrag pro Stück ist null oder negativ. So wird die Nutzschwelle nicht erreicht. Preis erhöhen oder variable Kosten senken.";
      }

      if (m.quantity < m.breakEvenQty) {
        const fehlmenge = Math.max(0, Math.ceil(m.breakEvenQty - m.quantity));
        return `Unterhalb der Nutzschwelle: Es fehlen etwa ${integer.format(fehlmenge)} Stück bis zum Break-even.`;
      }

      if (m.profit < m.fixedCost * 0.2) {
        return "Nutzschwelle erreicht, aber mit kleinem Puffer. Kleine Preis- oder Kostenänderungen wirken stark auf die Marge.";
      }

      return "Über der Nutzschwelle mit solidem Ergebnisbeitrag. Teste als Nächstes die Empfindlichkeit gegenüber variablen Kosten.";
    };

    const updateKPIs = (m) => {
      outputs.priceValue.textContent = currency.format(m.price);
      outputs.variableCostValue.textContent = currency.format(m.variableCost);
      outputs.fixedCostValue.textContent = currency.format(m.fixedCost);
      outputs.quantityValue.textContent = `${integer.format(m.quantity)} Stück`;

      outputs.kpiDbUnit.textContent = currency.format(m.dbUnit);
      outputs.kpiDbUnit.className = m.dbUnit >= 0 ? "gut" : "schlecht";
      outputs.kpiDbQuote.textContent = `DB-Quote: ${percent.format(m.dbQuote)}`;

      outputs.kpiSelfCost.textContent = currency.format(m.selfCostPerUnit);

      outputs.kpiMargin.textContent = percent.format(m.margin);
      outputs.kpiMargin.className = m.margin >= 0 ? "gut" : "schlecht";

      outputs.kpiProfit.textContent = `Ergebnis: ${currency.format(m.profit)}`;
      outputs.kpiProfit.className = m.profit >= 0 ? "info gut" : "info schlecht";

      if (Number.isFinite(m.breakEvenQty)) {
        outputs.kpiBreakEvenQty.textContent = `${integer.format(Math.ceil(m.breakEvenQty))} Stück`;
        outputs.kpiBreakEvenRev.textContent = `Break-even-Umsatz: ${currency.format(m.breakEvenRevenue)}`;
      } else {
        outputs.kpiBreakEvenQty.textContent = "nicht erreichbar";
        outputs.kpiBreakEvenRev.textContent = "Deckungsbeitrag ≤ 0";
      }

      outputs.kpiRevenue.textContent = currency.format(m.revenue);
      outputs.kpiTotalCost.textContent = currency.format(m.totalCost);
      outputs.scenarioHint.textContent = scenarioText(m);
    };

    const svgEl = (name, attrs = {}) => {
      const el = document.createElementNS(svgNS, name);
      Object.entries(attrs).forEach(([key, value]) => {
        el.setAttribute(key, String(value));
      });
      return el;
    };

    const clearSvg = (svg) => {
      while (svg.firstChild) {
        svg.removeChild(svg.firstChild);
      }
    };

    const drawBreakEvenChart = (m) => {
      const svg = outputs.breakEvenChart;
      clearSvg(svg);

      const width = 860;
      const height = 460;
      const margin = { top: 20, right: 22, bottom: 62, left: 90 };
      const innerW = width - margin.left - margin.right;
      const innerH = height - margin.top - margin.bottom;

      let maxQty = Math.max(800, m.quantity * 1.4);
      if (Number.isFinite(m.breakEvenQty)) {
        maxQty = Math.max(maxQty, m.breakEvenQty * 1.2);
      }
      maxQty = Math.min(20000, Math.max(200, maxQty));

      const maxVal = Math.max(
        m.price * maxQty,
        m.fixedCost + m.variableCost * maxQty,
        m.fixedCost,
        1
      ) * 1.08;

      const x = (q) => margin.left + (q / maxQty) * innerW;
      const y = (v) => margin.top + innerH - (v / maxVal) * innerH;

      svg.appendChild(svgEl("rect", {
        x: margin.left,
        y: margin.top,
        width: innerW,
        height: innerH,
        fill: "#ffffff",
        stroke: "#e2e8ef",
      }));

      for (let i = 0; i <= 6; i += 1) {
        const v = (maxVal / 6) * i;
        const yy = y(v);

        svg.appendChild(svgEl("line", {
          x1: margin.left,
          x2: width - margin.right,
          y1: yy,
          y2: yy,
          stroke: "#eef2f6",
        }));

        const label = svgEl("text", {
          x: margin.left - 10,
          y: yy + 4,
          "text-anchor": "end",
          fill: "#5c6978",
          "font-size": "11",
        });
        label.textContent = currency.format(v);
        svg.appendChild(label);
      }

      for (let i = 0; i <= 6; i += 1) {
        const q = (maxQty / 6) * i;
        const xx = x(q);

        svg.appendChild(svgEl("line", {
          x1: xx,
          x2: xx,
          y1: margin.top,
          y2: height - margin.bottom,
          stroke: "#f2f5f8",
        }));

        const qLabel = svgEl("text", {
          x: xx,
          y: height - margin.bottom + 18,
          "text-anchor": "middle",
          fill: "#5c6978",
          "font-size": "11",
        });
        qLabel.textContent = integer.format(q);
        svg.appendChild(qLabel);
      }

      svg.appendChild(svgEl("line", {
        x1: margin.left,
        x2: margin.left,
        y1: margin.top,
        y2: height - margin.bottom,
        stroke: "#6e7e8b",
        "stroke-width": "1.2",
      }));

      svg.appendChild(svgEl("line", {
        x1: margin.left,
        x2: width - margin.right,
        y1: height - margin.bottom,
        y2: height - margin.bottom,
        stroke: "#6e7e8b",
        "stroke-width": "1.2",
      }));

      const xText = svgEl("text", {
        x: width / 2,
        y: height - 10,
        "text-anchor": "middle",
        fill: "#455261",
        "font-size": "12",
      });
      xText.textContent = "Absatzmenge (Stück)";
      svg.appendChild(xText);

      const yText = svgEl("text", {
        x: 18,
        y: height / 2,
        transform: `rotate(-90 18 ${height / 2})`,
        "text-anchor": "middle",
        fill: "#455261",
        "font-size": "12",
      });
      yText.textContent = "CHF pro Periode";
      svg.appendChild(yText);

      const makePath = (fn, color, dash = "") => {
        const steps = 70;
        let d = "";
        for (let i = 0; i <= steps; i += 1) {
          const q = (maxQty / steps) * i;
          d += `${i === 0 ? "M" : "L"}${x(q).toFixed(2)} ${y(fn(q)).toFixed(2)} `;
        }

        svg.appendChild(svgEl("path", {
          d,
          fill: "none",
          stroke: color,
          "stroke-width": "2.8",
          "stroke-linecap": "round",
          "stroke-dasharray": dash,
        }));
      };

      makePath((q) => m.price * q, "#c2410c");
      makePath((q) => m.fixedCost + m.variableCost * q, "#334155");
      makePath(() => m.fixedCost, "#64748b", "6 5");

      const xQty = x(Math.min(m.quantity, maxQty));
      svg.appendChild(svgEl("line", {
        x1: xQty,
        x2: xQty,
        y1: margin.top,
        y2: height - margin.bottom,
        stroke: "#0f766e",
        "stroke-width": "1.4",
        "stroke-dasharray": "4 4",
        opacity: "0.75",
      }));

      const qText = svgEl("text", {
        x: xQty,
        y: margin.top + 14,
        "text-anchor": "middle",
        fill: "#0f766e",
        "font-size": "11",
      });
      qText.textContent = `Absatz: ${integer.format(m.quantity)} Stück`;
      svg.appendChild(qText);

      if (Number.isFinite(m.breakEvenQty) && m.breakEvenQty <= maxQty) {
        const beX = x(m.breakEvenQty);
        const beY = y(m.price * m.breakEvenQty);

        svg.appendChild(svgEl("circle", {
          cx: beX,
          cy: beY,
          r: 5.8,
          fill: "#0f766e",
          stroke: "#ffffff",
          "stroke-width": "2",
        }));

        const beLabel = svgEl("text", {
          x: beX + 8,
          y: beY - 10,
          fill: "#0f766e",
          "font-size": "11",
          "font-weight": "700",
        });
        beLabel.textContent = `Break-even: ${integer.format(Math.ceil(m.breakEvenQty))} Stück`;
        svg.appendChild(beLabel);
      } else if (Number.isFinite(m.breakEvenQty)) {
        const note = svgEl("text", {
          x: width - margin.right - 4,
          y: margin.top + 14,
          "text-anchor": "end",
          fill: "#a16207",
          "font-size": "11",
        });
        note.textContent = "Break-even liegt außerhalb des Diagramms";
        svg.appendChild(note);
      }
    };

    const drawImpactChart = (m) => {
      const svg = outputs.impactChart;
      clearSvg(svg);

      const width = 860;
      const height = 340;
      const margin = { top: 18, right: 22, bottom: 60, left: 86 };
      const innerW = width - margin.left - margin.right;
      const innerH = height - margin.top - margin.bottom;

      const rows = [
        { name: "Umsatz", value: m.revenue, color: "#c2410c" },
        { name: "Variable Kosten", value: -m.variableTotal, color: "#334155" },
        { name: "Fixkosten", value: -m.fixedCost, color: "#64748b" },
        { name: "Ergebnis", value: m.profit, color: m.profit >= 0 ? "#15803d" : "#b91c1c" },
      ];

      const maxAbs = Math.max(...rows.map((r) => Math.abs(r.value)), 1) * 1.2;
      const yMin = -maxAbs;
      const yMax = maxAbs;
      const y = (v) => margin.top + ((yMax - v) / (yMax - yMin)) * innerH;
      const xStep = innerW / rows.length;
      const barW = Math.min(120, xStep * 0.58);
      const zeroY = y(0);

      svg.appendChild(svgEl("rect", {
        x: margin.left,
        y: margin.top,
        width: innerW,
        height: innerH,
        fill: "#ffffff",
        stroke: "#e2e8ef",
      }));

      for (let i = 0; i <= 4; i += 1) {
        const v = yMin + ((yMax - yMin) / 4) * i;
        const yy = y(v);

        svg.appendChild(svgEl("line", {
          x1: margin.left,
          x2: width - margin.right,
          y1: yy,
          y2: yy,
          stroke: i === 2 ? "#c6d2dc" : "#f1f5f8",
          "stroke-width": i === 2 ? "1.2" : "1",
        }));

        const yLabel = svgEl("text", {
          x: margin.left - 10,
          y: yy + 4,
          "text-anchor": "end",
          fill: "#556371",
          "font-size": "11",
        });
        yLabel.textContent = currency.format(v);
        svg.appendChild(yLabel);
      }

      rows.forEach((row, idx) => {
        const cx = margin.left + xStep * idx + xStep / 2;
        const top = Math.min(y(row.value), zeroY);
        const h = Math.max(2, Math.abs(y(row.value) - zeroY));

        svg.appendChild(svgEl("rect", {
          x: cx - barW / 2,
          y: top,
          width: barW,
          height: h,
          rx: 5,
          fill: row.color,
          opacity: "0.93",
        }));

        const valueLabel = svgEl("text", {
          x: cx,
          y: row.value >= 0 ? top - 8 : top + h + 14,
          "text-anchor": "middle",
          fill: row.color,
          "font-size": "11",
          "font-weight": "700",
        });
        valueLabel.textContent = currency.format(row.value);
        svg.appendChild(valueLabel);

        const xLabel = svgEl("text", {
          x: cx,
          y: height - margin.bottom + 20,
          "text-anchor": "middle",
          fill: "#41515f",
          "font-size": "12",
        });
        xLabel.textContent = row.name;
        svg.appendChild(xLabel);
      });

      const caption = svgEl("text", {
        x: width / 2,
        y: height - 12,
        "text-anchor": "middle",
        fill: "#41515f",
        "font-size": "12",
      });
      caption.textContent = "Werte beim geplanten Absatz";
      svg.appendChild(caption);
    };

    const render = () => {
      const model = calculateModel(readInputs());
      updateKPIs(model);
      drawBreakEvenChart(model);
      drawImpactChart(model);
    };

    Object.values(controls).forEach((control) => {
      control.addEventListener("input", render);
    });

    document.querySelectorAll(".ebene-toggle").forEach((button) => {
      button.addEventListener("click", () => toggleAnalyseEbene(button.dataset.target));
    });

    setAnalyseLayout();
    render();
  </script>
</body>
</html>
